@model finder_work.Models.User

@{
    ViewData["Title"] = "Cài đặt tài khoản";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4><i class="bi bi-gear me-2"></i>Cài đặt tài khoản</h4>
                    <p class="mb-0">Quản lý thông tin cá nhân và bảo mật tài khoản</p>
                </div>
                <div class="card-body">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>@TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- Profile Information Section -->
                    <div class="row mb-5">
                        <div class="col-12">
                            <h5 class="text-primary border-bottom pb-2">
                                <i class="bi bi-person-circle me-2"></i>Thông tin cá nhân
                            </h5>
                        </div>
                    </div>

                    <form asp-action="UpdateProfile" method="post" enctype="multipart/form-data" id="profileForm">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="text-center mb-3">
                                    <div class="avatar-container position-relative d-inline-block">
                                        @if (!string.IsNullOrEmpty(Model.Avata))
                                        {
                                            <img src="@Model.Avata" alt="@Model.FullName" 
                                                 class="rounded-circle border" width="120" height="120" 
                                                 style="object-fit: cover;" id="avatarPreview">
                                        }
                                        else
                                        {
                                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white border" 
                                                 style="width: 120px; height: 120px; font-size: 3rem;" id="avatarPreview">
                                                @(Model.FullName?.FirstOrDefault().ToString().ToUpper() ?? "U")
                                            </div>
                                        }
                                        <div class="position-absolute bottom-0 end-0">
                                            <label for="avatar" class="btn btn-primary btn-sm rounded-circle" style="width: 35px; height: 35px;">
                                                <i class="bi bi-camera"></i>
                                            </label>
                                        </div>
                                    </div>
                                    <input type="file" class="d-none" id="avatar" name="avatar" accept="image/*">
                                    <div class="form-text mt-2">Chấp nhận file .jpg, .jpeg, .png, .gif (tối đa 5MB)</div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="fullName" class="form-label">Họ và tên *</label>
                                            <input type="text" class="form-control" id="fullName" name="fullName" 
                                                   value="@Model.FullName" required
                                                   placeholder="Nhập họ và tên đầy đủ">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="phoneNumber" class="form-label">Số điện thoại</label>
                                            <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" 
                                                   value="@Model.PhoneNumber"
                                                   placeholder="Nhập số điện thoại">
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="email" 
                                                   value="@Model.Email" readonly
                                                   placeholder="Email không thể thay đổi">
                                            <div class="form-text">Email không thể thay đổi sau khi đăng ký</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle me-2"></i>Cập nhật thông tin
                                </button>
                            </div>
                        </div>
                    </form>

                    <hr class="my-5">

                    <!-- Password Change Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary border-bottom pb-2">
                                <i class="bi bi-shield-lock me-2"></i>Thay đổi mật khẩu
                            </h5>
                        </div>
                    </div>

                    <form asp-action="ChangePassword" method="post" id="passwordForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">Mật khẩu hiện tại *</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="currentPassword" name="currentPassword" 
                                               required placeholder="Nhập mật khẩu hiện tại">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">Mật khẩu mới *</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="newPassword" name="newPassword" 
                                               required placeholder="Nhập mật khẩu mới">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Mật khẩu phải có ít nhất 8 ký tự</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">Xác nhận mật khẩu *</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" 
                                               required placeholder="Nhập lại mật khẩu mới">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 text-end">
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-shield-check me-2"></i>Thay đổi mật khẩu
                                </button>
                            </div>
                        </div>
                    </form>

                    <hr class="my-5">

                    <!-- Account Actions Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary border-bottom pb-2">
                                <i class="bi bi-person-gear me-2"></i>Quản lý tài khoản
                            </h5>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <i class="bi bi-file-person text-info" style="font-size: 3rem;"></i>
                                    <h6 class="card-title mt-3">Quản lý hồ sơ</h6>
                                    <p class="card-text text-muted">Xem và chỉnh sửa các hồ sơ tìm việc của bạn</p>
                                    <a href="@Url.Action("Index", "Profile")" class="btn btn-info">
                                        <i class="bi bi-arrow-right me-2"></i>Xem hồ sơ
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <i class="bi bi-plus-circle text-success" style="font-size: 3rem;"></i>
                                    <h6 class="card-title mt-3">Tạo hồ sơ mới</h6>
                                    <p class="card-text text-muted">Tạo thêm hồ sơ mới để ứng tuyển nhiều vị trí</p>
                                    <a href="@Url.Action("Create", "Profile")" class="btn btn-success">
                                        <i class="bi bi-plus me-2"></i>Tạo hồ sơ
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12 text-center">
                            <a href="@Url.Action("Index", "Home")" class="btn btn-secondary">
                                <i class="bi bi-house me-2"></i>Quay lại trang chủ
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
// Avatar preview functionality
document.getElementById('avatar').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            alert('Chỉ chấp nhận file ảnh (.jpg, .jpeg, .png, .gif)!');
            e.target.value = '';
            return;
        }
        
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('Kích thước file không được vượt quá 5MB!');
            e.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const avatarPreview = document.getElementById('avatarPreview');
            avatarPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="rounded-circle border" width="120" height="120" style="object-fit: cover;">`;
        };
        reader.readAsDataURL(file);
    }
});

// Password visibility toggle functions
function togglePasswordVisibility(inputId, buttonId) {
    const input = document.getElementById(inputId);
    const button = document.getElementById(buttonId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

document.getElementById('toggleCurrentPassword').addEventListener('click', function() {
    togglePasswordVisibility('currentPassword', 'toggleCurrentPassword');
});

document.getElementById('toggleNewPassword').addEventListener('click', function() {
    togglePasswordVisibility('newPassword', 'toggleNewPassword');
});

document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
    togglePasswordVisibility('confirmPassword', 'toggleConfirmPassword');
});

// Password validation
document.getElementById('newPassword').addEventListener('input', function() {
    const password = this.value;
    const confirmPassword = document.getElementById('confirmPassword');
    
    if (password.length < 8) {
        this.setCustomValidity('Mật khẩu phải có ít nhất 8 ký tự');
    } else {
        this.setCustomValidity('');
    }
    
    if (confirmPassword.value && password !== confirmPassword.value) {
        confirmPassword.setCustomValidity('Mật khẩu không khớp');
    } else {
        confirmPassword.setCustomValidity('');
    }
});

document.getElementById('confirmPassword').addEventListener('input', function() {
    const password = document.getElementById('newPassword').value;
    
    if (this.value !== password) {
        this.setCustomValidity('Mật khẩu không khớp');
    } else {
        this.setCustomValidity('');
    }
});

// Form validation
document.getElementById('passwordForm').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        e.preventDefault();
        alert('Mật khẩu mới và xác nhận mật khẩu không khớp!');
        return false;
    }
    
    if (newPassword.length < 8) {
        e.preventDefault();
        alert('Mật khẩu mới phải có ít nhất 8 ký tự!');
        return false;
    }
});
</script>
}

<style>
.avatar-container:hover .position-absolute {
    opacity: 1;
}

.avatar-container .position-absolute {
    opacity: 0.8;
    transition: opacity 0.3s ease;
}

.card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}
</style>